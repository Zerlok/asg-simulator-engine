<!DOCTYPE html>
<html ng-app="">
<head>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/>

	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">

	<link rel="stylesheet" href="/static/plumb/css/jsPlumbToolkit-defaults.css">
	<link rel="stylesheet" href="/static/plumb/css/main.css">
	<link rel="stylesheet" href="/static/plumb/css/jsPlumbToolkit-demo.css">
	<link rel="stylesheet" href="/static/plumb/dist/demo/flowchart/demo.css">

	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
	<script src="/static/plumb/jsPlumb-2.2.8-min.js"></script>
</head>
<body data-demo-id="flowchart">
	<div class="jtk-demo-main">
		<!-- demo -->
		<div class="jtk-demo-canvas canvas-wide flowchart-demo jtk-surface jtk-surface-nopan" id="asg-node-container">
			<div class="window jtk-node asg-node" id="flowchartWindow1"><strong>1</strong></div>
			<div class="window jtk-node asg-node" id="flowchartWindow2"><strong>2</strong></div>
			<div class="window jtk-node asg-node" id="flowchartWindow3"><strong>3</strong></div>
			<div class="window jtk-node asg-node" id="flowchartWindow4"><strong>4</strong></div>
			<div class="window jtk-node asg-node" id="flowchartWindow5"><strong>5</strong></div>
		</div>
	</div>

    <script>
		jsPlumb.ready(function () {
			var instance = window.jsp = jsPlumb.getInstance({
				Container: "asg-node-container",
				DragOptions: { cursor: 'pointer', zIndex: 2000 },
				// ConnectionsDetachable: true,
				ConnectionOverlays: [
					[ "Arrow", {
						location: 1,
						visible: true,
						width: 11,
						length: 16,
						id:"ARROW"
					} ]
				]
			});

			// this is the paint style for the connecting lines..
			var connectorPaintStyle = {
					strokeWidth: 2,
					stroke: "#535353",
					joinstyle: "round",
					outlineStroke: null
				},
			// .. and this is the hover style.
				connectorHoverStyle = {
					stroke: "#216477",
					outlineStroke: null
				},
				endpointHoverStyle = {
					fill: "#216477",
					outlineStroke: null
				},
			// the definition of source endpoints (the small blue ones)
				sourceEndpointParams = {
					isSource: true,
					endpoint: "Dot",
					paintStyle: {
						stroke: "#7AB02C",
						fill: "transparent",
						radius: 5,
						strokeWidth: 1
					},
					connector: [ "Bezier", { curviness: 150, alwaysRespectStubs: false } ],
					connectorStyle: connectorPaintStyle,
					hoverPaintStyle: endpointHoverStyle,
					connectorHoverStyle: connectorHoverStyle,
					dragOptions: {}
				},
			// the definition of target endpoints (will appear when the user drags a connection)
				targetEndpointParams = {
					isTarget: true,
					endpoint: "Dot",
					paintStyle: {
						fill: "#7AB02C",
						radius: 5
					},
					hoverPaintStyle: endpointHoverStyle,
					dropOptions: { hoverClass: "hover", activeClass: "active" },
					maxConnections: -1
				},
				init = function (connection) {
					console.log(`${connection.sourceId} --> ${connection.targetId}`);
					// connection.getOverlay("label").setLabel(connection.sourceId.substring(15) + "-" + connection.targetId.substring(15));
				};

			const nodesId = "flowchart";
			var _addEndpoints = function (toId, inputs, outputs) {
				var len = inputs.length;
				for (var i = 0; i < len; i++) {
					instance.addEndpoint(nodesId + toId, targetEndpointParams, {
						anchor: [0.0, (i+1) / (len+1), -0.8, 0],
						uuid: toId + "-in-" + inputs[i]
					});
				}
				len = outputs.length;
				for (var i = 0; i < len; i++) {
					instance.addEndpoint(nodesId + toId, sourceEndpointParams, {
						anchor: [1.0, (i+1) / (len+1), 0.8, 0],
						uuid: toId + "-out-" + outputs[i]
					});
				}
			};

			// suspend drawing and initialise.
			instance.batch(function () {
				_addEndpoints("Window1", ["foo", "baz"], ["bar"]);
				_addEndpoints("Window2", ["foo"], ["bar", "yt", "tyy"]);
				_addEndpoints("Window3", ["foo"], ["bar"]);
				_addEndpoints("Window4", ["foo", "baz"], ["bar"]);
				_addEndpoints("Window5", ["foo"], ["bar"]);

				// listen for new connections; initialise them the same way we initialise the connections at startup.
				instance.bind("connection", function (connInfo, originalEvent) {
					init(connInfo.connection);
					console.log(connInfo.connection);
				});

				// make all the window divs draggable
				// instance.draggable(jsPlumb.getSelector(".flowchart-demo .window"), { grid: [20, 20] });
				// THIS DEMO ONLY USES getSelector FOR CONVENIENCE. Use your library's appropriate selector
				// method, or document.querySelectorAll:
				// jsPlumb.draggable(document.querySelectorAll(".window"), { grid: [20, 20] });
				instance.draggable($(".asg-node"));

				// connect a few up
				instance.connect({uuids: ["Window1-out-bar", "Window2-in-foo"]});
				instance.connect({uuids: ["Window2-out-bar", "Window4-in-foo"]});
				instance.connect({uuids: ["Window2-out-tyy", "Window4-in-baz"]});
				instance.connect({uuids: ["Window3-out-bar", "Window5-in-foo"]});

				//
				// listen for clicks on connections, and offer to delete connections on click.
				//
				instance.bind("click", function (conn, originalEvent) {
				   // if (confirm("Delete connection from " + conn.sourceId + " to " + conn.targetId + "?"))
					 //   instance.detach(conn);
					conn.toggleType("basic");
				});

				instance.bind("connectionDrag", function (connection) {
					console.log("connection " + connection.id + " is being dragged. suspendedElement is ", connection.suspendedElement, " of type ", connection.suspendedElementType);
				});

				instance.bind("connectionDragStop", function (connection) {
					console.log("connection " + connection.id + " was dragged");
				});

				instance.bind("connectionMoved", function (params) {
					console.log("connection " + params.connection.id + " was moved");
				});
			});
			// jsPlumb.fire("jsPlumbDemoLoaded", instance);
		});
	</script>

</body>
</html>
